name: Daily Video Upload

on:
  schedule:
    # Run daily at 10 AM UTC (adjust timezone as needed)
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-credentials:
    runs-on: ubuntu-latest
    outputs:
      has-credentials: ${{ steps.check.outputs.has-credentials }}

    steps:
      - name: Check if YouTube credentials are configured
        id: check
        run: |
          # Check if all required secrets are configured
          if [ -n "${{ secrets.YT_CLIENT_ID }}" ] && \
             [ -n "${{ secrets.YT_CLIENT_SECRET }}" ] && \
             [ -n "${{ secrets.YT_REFRESH_TOKEN }}" ] && \
             [ -n "${{ secrets.YT_CHANNEL_ID }}" ] && \
             [ -n "${{ secrets.PEXELS_API_KEY }}" ] && \
             [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "has-credentials=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All required credentials are configured"
          else
            echo "has-credentials=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è  Missing YouTube or API credentials - video upload will be skipped"
            echo ""
            echo "Required secrets:"
            # Display status of each required secret (duplicated for clarity)
            echo "  - YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID != '' && '‚úì' || '‚úó' }}"
            echo "  - YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET != '' && '‚úì' || '‚úó' }}"
            echo "  - YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN != '' && '‚úì' || '‚úó' }}"
            echo "  - YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID != '' && '‚úì' || '‚úó' }}"
            echo "  - PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY != '' && '‚úì' || '‚úó' }}"
            echo "  - OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY != '' && '‚úì' || '‚úó' }}"
            echo ""
            echo "üí° Video upload is optional. The site works fine without it."
            echo "üìö See SETUP.md for credential setup instructions."
          fi

  upload-video:
    needs: check-credentials
    if: needs.check-credentials.outputs.has-credentials == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install dependencies
        run: npm install

      - name: Create .env file
        run: |
          cat << EOF > .env
          PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }}
          FORGEFINDS_LOGO_PATH=${{ github.workspace }}/forgefinds-logo.png
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL=gpt-4o-mini
          YT_CLIENT_ID=${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET=${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN=${{ secrets.YT_REFRESH_TOKEN }}
          YT_CHANNEL_ID=${{ secrets.YT_CHANNEL_ID }}
          DISABLE_TELEMETRY=true
          EOF

      - name: Run video agent
        run: npm run video:one

      - name: Commit updated posted.json
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/posted.json
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: mark deal as posted [skip ci]"
          git push

  skip-notification:
    needs: check-credentials
    if: needs.check-credentials.outputs.has-credentials == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Notify skipped
        run: |
          echo "‚è≠Ô∏è  Video upload workflow skipped"
          echo ""
          echo "Reason: Required YouTube/API credentials are not configured"
          echo ""
          echo "This is normal if you haven't set up video uploads yet."
          echo "The daily deals scraper continues to work independently."
          echo ""
          echo "To enable video uploads:"
          echo "  1. See SETUP.md for detailed setup instructions"
          echo "  2. Configure the required GitHub Secrets"
          echo "  3. The workflow will run automatically once configured"
