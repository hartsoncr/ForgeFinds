<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Browse Deals — ForgeFinds</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Hide this page from bots -->
  <meta name="robots" content="noindex, noarchive">
  <link rel="icon" href="/forgefinds-favicon.png">
  <link rel="preconnect" href="https://m.media-amazon.com">
  <style>
    :root{
      --bg:#0f1115;--card:#12151d;--line:#202635;--text:#e6edf6;--muted:#a7b0bf;
      --accent:#f97316;--good:#9ef199;--goodbg:#1e2a1e;--couponbg:#19233a;--couponfg:#9dc4ff
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{padding:18px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);background:var(--bg);position:sticky;top:0;z-index:2}
    header img{width:28px;height:28px}
    a.logo{display:flex;align-items:center;gap:10px;color:inherit;text-decoration:none}
    main{padding:20px}
    .toolbar{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;margin:6px 0 16px}
    .subbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:0 0 18px}
    input[type="search"], input[type="number"], select{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0b0d10;color:var(--text)
    }
    input[type="number"]{width:110px}
    .pills{display:flex;flex-wrap:wrap;gap:8px}
    .pill{padding:7px 11px;border:1px solid var(--line);border-radius:999px;background:#0b0d10;color:var(--text);cursor:pointer;font-size:.9rem}
    .pill[data-active="1"]{background:#1b2130}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .deal-card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .deal-card .imgwrap{display:block;background:#0b0d10}
    .deal-card img{width:100%;height:220px;object-fit:cover}
    .deal-card .content{padding:12px 14px}
    .deal-card .title{font-size:1.05rem;line-height:1.25;margin:0 0 6px}
    .deal-card .desc{color:var(--muted);font-size:.9rem;margin:0 0 10px}
    .deal-card .meta{display:flex;align-items:center;gap:8px;margin:0 0 10px;flex-wrap:wrap}
    .price{background:var(--goodbg);color:var(--good);padding:4px 8px;border-radius:8px;font-weight:600}
    .badge.coupon{background:var(--couponbg);color:var(--couponfg);padding:4px 8px;border-radius:8px;font-weight:600}
    .badge.off{background:#1b1530;color:#c9a7ff;padding:4px 8px;border-radius:8px;font-weight:600}
    .cta{display:inline-block;background:var(--accent);color:#0b0d10;font-weight:700;border-radius:10px;padding:10px 12px;text-align:center}
    .empty{color:var(--muted)}
    .count{color:var(--muted);font-size:.9rem}
    .hint{color:var(--muted);font-size:.9rem;margin-top:10px}
  </style>
  <script src="/assets/deals.js" defer></script>
</head>
<body>
  <header>
    <a class="logo" href="/">
      <img src="/forgefinds-logo.png" alt="ForgeFinds">
      <strong>ForgeFinds</strong>
    </a>
    <nav><a href="/" style="color:#e6edf6;text-decoration:none">Home</a></nav>
  </header>

  <main>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Search deals…">
      <label>
        <select id="sort">
          <option value="newest">Sort: Newest</option>
          <option value="priceAsc">Price: Low → High</option>
          <option value="priceDesc">Price: High → Low</option>
          <option value="pctOff">% Off (High → Low)</option>
        </select>
      </label>
      <div>
        <input id="minPrice" type="number" min="0" step="0.01" placeholder="Min $" title="Minimum price">
        <input id="maxPrice" type="number" min="0" step="0.01" placeholder="Max $" title="Maximum price">
        <input id="minPct"   type="number" min="0" max="100" step="1" placeholder="Min % off" title="Minimum % off">
      </div>
    </div>

    <div class="subbar">
      <div id="cats" class="pills" aria-label="Categories"></div>
      <span class="count" id="count"></span>
    </div>

    <section class="grid" id="deals"></section>
    <p class="hint" id="hint" style="display:none;"></p>
  </main>

  <script>
    // -------- Hidden Preview with PIN -----------
    const PREVIEW_PIN = "4242"; // change this as you like
    const url = new URL(location.href);
    const preview = url.searchParams.get("preview") === "1" && (url.searchParams.get("pin") || "") === PREVIEW_PIN;

    // DOM
    const $q = document.getElementById("q");
    const $sort = document.getElementById("sort");
    const $cats = document.getElementById("cats");
    const $count = document.getElementById("count");
    const $minPrice = document.getElementById("minPrice");
    const $maxPrice = document.getElementById("maxPrice");
    const $minPct = document.getElementById("minPct");
    const $hint = document.getElementById("hint");

    // State
    let allDeals = [];
    let activeCat = "all";

    // ---------- Utilities: price & discount parsing ----------
    const moneyRx = /\$([\d,]+(?:\.\d{1,2})?)/g;
    function dollars(str){
      if (!str) return null;
      const m = /\$([\d,]+(?:\.\d{1,2})?)/.exec(str);
      return m ? parseFloat(m[1].replace(/,/g,"")) : null;
    }
    function percent(str){
      if (!str) return null;
      const m = /(\d{1,3})\s*%/.exec(str);
      return m ? parseFloat(m[1]) : null;
    }
    function effectivePrice(d){
      // Base from display_price -> price_info
      let base = dollars(d.display_price) ?? dollars(d.price_info);
      const couponText = (d.coupon || d.price_info || "").toLowerCase();
      const dollarOff = dollars(couponText);      // "$50 off", "$4.60 coupon"
      const pctOff    = percent(couponText);      // "Save 10% at checkout"
      if (base != null){
        if (pctOff != null) base = +(base * (1 - pctOff/100)).toFixed(2);
        if (dollarOff != null) base = Math.max(0, +(base - dollarOff).toFixed(2));
      }
      return base; // may be null
    }
    function discountPercent(d){
      const cur = effectivePrice(d);
      if (cur == null) return percent(d.coupon || d.price_info);
      let was = null;
      const info = d.price_info || "";
      const money = [...info.matchAll(moneyRx)].map(m=>parseFloat(m[1].replace(/,/g,"")));
      if (info.toLowerCase().includes("was") && money.length >= 2){
        was = money[money.length-1];
      }
      const explicitPct = percent(d.coupon || d.price_info);
      if (explicitPct != null) return explicitPct;
      if (was != null && was > 0 && cur <= was) return Math.round(100 * (1 - cur/was));
      return null;
    }
    function comparePriceAsc(a,b){
      const pa = effectivePrice(a), pb = effectivePrice(b);
      if (pa==null && pb==null) return 0;
      if (pa==null) return 1;
      if (pb==null) return -1;
      return pa - pb;
    }
    const comparePriceDesc = (a,b) => -comparePriceAsc(a,b);
    function comparePctOffDesc(a,b){
      const pa = discountPercent(a), pb = discountPercent(b);
      if (pa==null && pb==null) return 0;
      if (pa==null) return 1;
      if (pb==null) return -1;
      return pb - pa;
    }

    // ---------- UI helpers ----------
    function uniqueCategories(items){
      const set = new Set(items.map(d => (d.category || "other")));
      return ["all", ...Array.from(set).sort()];
    }
    function pill(label, active=false){
      const el = document.createElement("button");
      el.className = "pill";
      el.dataset.active = active ? "1" : "0";
      el.textContent = label;
      el.addEventListener("click", () => {
        activeCat = label;
        document.querySelectorAll(".pill").forEach(p => p.dataset.active = (p.textContent === label) ? "1" : "0");
        refresh();
      });
      return el;
    }

    function clientFilter(src){
      const q = ($q.value || "").trim().toLowerCase();
      const min$ = $minPrice.value ? parseFloat($minPrice.value) : null;
      const max$ = $maxPrice.value ? parseFloat($maxPrice.value) : null;
      const minPct = $minPct.value ? parseFloat($minPct.value) : null;

      return src.filter(d => {
        // category
        const catOK = (activeCat === "all") || ((d.category || "other") === activeCat);
        if (!catOK) return false;

        // search
        if (q){
          const hay = [
            d.title || "",
            d.description || "",
            (d.tags || []).join(" "),
            d.category || ""
          ].join(" ").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        // price range
        const p = effectivePrice(d);
        if (min$ != null && (p == null || p < min$)) return false;
        if (max$ != null && (p == null || p > max$)) return false;

        // percent off
        const pct = discountPercent(d);
        if (minPct != null && (pct == null || pct < minPct)) return false;

        return true;
      });
    }

    function clientSort(list){
      const mode = $sort.value;
      const arr = list.slice();
      if (mode === "priceAsc") arr.sort(comparePriceAsc);
      else if (mode === "priceDesc") arr.sort(comparePriceDesc);
      else if (mode === "pctOff") arr.sort(comparePctOffDesc);
      // else newest: keep original order (loader already returns newest → oldest)
      return arr;
    }

    async function refresh(){
      const filtered = clientSort(clientFilter(allDeals));
      // update count
      $count.textContent = `${filtered.length} deal${filtered.length===1?'':'s'}`;

      // render directly from the filtered list (no loader stub)
      ForgeFinds.renderFromList(filtered, "#deals");

      // empty state hint
      const none = filtered.length === 0;
      $hint.style.display = none ? "block" : "none";
      if (none){
        $hint.textContent = preview
          ? "No deals match your filters."
          : "No live deals match your filters. For scheduled items, append ?preview=1&pin=4242 to the URL.";
      }
    }

    async function init(){
      // Load deals (live or live+scheduled)
      allDeals = await ForgeFinds.loadDeals({ includeScheduled: preview });

      // Build category pills
      const cats = uniqueCategories(allDeals);
      $cats.innerHTML = "";
      cats.forEach((c, i) => $cats.appendChild(pill(c, i===0)));

      // Wire events
      [$q, $sort, $minPrice, $maxPrice, $minPct].forEach(el => el.addEventListener("input", refresh));
      $sort.addEventListener("change", refresh);

      // First paint
      refresh();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
