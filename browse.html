<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Browse Deals — ForgeFinds</title>
  <meta name="description" content="Browse all ForgeFinds deals. Filter by category, search, and sort." />
  <link rel="icon" href="favicon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#000;--panel:#111214;--text:#e6e6e6;--muted:#9aa0a6;--accent:#ff4d00;--ring:#272a2f}
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:24px 16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    h1{font:700 26px/1 "Bebas Neue",sans-serif;margin:0;color:var(--accent)}
    .back{margin-left:auto;border:1px solid var(--ring);padding:8px 12px;border-radius:10px}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px}
    input,select{background:#0f0f10;border:1px solid var(--ring);color:#fff;padding:10px;border-radius:10px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{grid-column:span 12;background:linear-gradient(180deg,#121316,#0b0c0e);border:1px solid var(--ring);border-radius:16px;overflow:hidden}
    @media(min-width:700px){.card{grid-column:span 6}}
    @media(min-width:1000px){.card{grid-column:span 4}}
    .card img{width:100%;height:200px;object-fit:cover;border-bottom:1px solid var(--ring)}
    .body{padding:14px}
    .title{margin:0 0 6px;font:700 18px/1.25 Poppins}
    .desc{margin:0 0 12px;color:var(--muted);font-size:14px;line-height:1.5}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .deal-btn{background:linear-gradient(to right,#ff4d00,#d72600);border:none;color:#fff;padding:10px 12px;border-radius:12px;font-weight:800;text-transform:uppercase;letter-spacing:.2px;font-size:12px}
    .mini{color:var(--muted);font-size:12px}
    .empty{border:1px dashed var(--ring);border-radius:14px;padding:16px;text-align:center;color:var(--muted)}
    .pager{display:flex;gap:8px;justify-content:center;margin:18px 0}
    .pager a{padding:8px 12px;border:1px solid var(--ring);border-radius:10px;background:#0f0f10}
    .meta{color:var(--muted);font-size:12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Browse Deals</h1>
      <a class="back" href="index.html">← Back to latest</a>
    </header>

    <div class="filters">
      <input id="q" type="search" placeholder="Search deals…" />
      <select id="cat">
        <option value="">All categories</option>
        <option>chargers</option><option>audio</option><option>smart-home</option>
        <option>pc-office</option><option>gaming</option><option>phone-accessories</option>
        <option>wearables</option><option>kitchen-home</option><option>random-cool</option>
      </select>
      <select id="sort">
        <option value="newest">Sort: Newest</option>
        <option value="discount">Sort: Highest discount</option>
        <option value="price">Sort: Lowest price</option>
      </select>
      <select id="per">
        <option value="12">Show 12</option>
        <option value="24">Show 24</option>
        <option value="48">Show 48</option>
      </select>
    </div>

    <div id="meta" class="meta"></div>
    <section id="grid" class="grid"><div class="empty">Loading deals…</div></section>
    <div id="pager" class="pager"></div>

    <div class="meta" id="updated"></div>
  </div>

  <script>
  (async function(){
    const $ = sel => document.querySelector(sel);
    const grid = $('#grid'), pager = $('#pager'), meta = $('#meta'), updated = $('#updated');
    const q = $('#q'), cat = $('#cat'), sort = $('#sort'), per = $('#per');

    // Load data
    let data = [];
    try{
      const res = await fetch('data/deals.json', {cache:'no-store'});
      data = await res.json();
    }catch(e){
      grid.innerHTML = '<div class="empty">Could not load deals. Try refresh.</div>';
      return;
    }

    // Read params
    const params = new URLSearchParams(location.search);
    q.value = params.get('q') || '';
    cat.value = params.get('cat') || '';
    sort.value = params.get('sort') || 'newest';
    per.value  = params.get('per')  || '12';
    let page   = parseInt(params.get('page') || '1',10);

    const now = new Date();
    let deals = data.filter(d => !d.expires_at || new Date(d.expires_at) >= now);

    // Render
    function render(){
      const term = q.value.trim().toLowerCase();
      let filtered = deals
        .filter(d => !cat.value || d.category === cat.value)
        .filter(d => !term || (
          (d.title||'').toLowerCase().includes(term) ||
          (d.description||'').toLowerCase().includes(term) ||
          (d.tags||[]).join(' ').toLowerCase().includes(term)
        ));

      // Sort
      if(sort.value==='newest'){
        filtered.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
      }else if(sort.value==='discount'){
        filtered.sort((a,b)=> (parseDiscount(b) - parseDiscount(a)));
      }else if(sort.value==='price'){
        filtered.sort((a,b)=> parsePrice(a) - parsePrice(b));
      }

      // Pagination
      const perPage = parseInt(per.value,10);
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / perPage));
      page = Math.min(Math.max(1,page), pages);
      const start = (page-1)*perPage, end = start + perPage;
      const slice = filtered.slice(start,end);

      // Cards
      grid.innerHTML = slice.length ? slice.map(renderCard).join('') :
        '<div class="empty">No matching deals yet. Try different filters.</div>';

      // Pager
      pager.innerHTML = pages>1 ? Array.from({length:pages},(_,i)=>{
        const p=i+1; const active = p===page? ' style="border-color:#ff4d00"' : '';
        const href = makeURL({page:p});
        return `<a${active} href="${href}">${p}</a>`;
      }).join('') : '';

      meta.textContent = `${total} deal(s) • Showing page ${page} of ${pages}`;
      const newest = filtered[0]?.created_at;
      updated.textContent = newest ? `Updated: ${new Date(newest).toLocaleString()}` : '';
    }

    function esc(s){return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function renderCard(d){
      const img = d.image_url ? `<img src="${esc(d.image_url)}" alt="${esc(d.title)}">` : '';
      const price = d.price_info ? ` <span class="mini">• ${esc(d.price_info)}</span>` : '';
      return `<article class="card">
        ${img}
        <div class="body">
          <h3 class="title">${esc(d.title)}</h3>
          <p class="desc">${esc(d.description)}</p>
          <div class="actions">
            <a class="deal-btn" href="${esc(d.affiliate_url)}" target="_blank" rel="sponsored noopener">Grab Deal</a>
            <span class="mini">${esc(d.store||'Online')}${price}</span>
          </div>
        </div>
      </article>`;
    }

    function parseDiscount(d){
      // tries to read "78% OFF" at start of title or in price_info
      const src = `${d.title||''} ${d.price_info||''}`;
      const m = src.match(/(\d{1,3})\s*%/);
      return m ? parseInt(m[1],10) : 0;
    }
    function parsePrice(d){
      const m = (d.price_info||'').match(/\$([\d\.]+)/);
      return m ? parseFloat(m[1]) : Number.POSITIVE_INFINITY;
    }

    function makeURL(overrides={}){
      const p = new URLSearchParams(location.search);
      [['q',q.value],['cat',cat.value],['sort',sort.value],['per',per.value]].forEach(([k,v])=> v ? p.set(k,v) : p.delete(k));
      Object.entries(overrides).forEach(([k,v])=> p.set(k,v));
      return `?${p.toString()}`;
    }

    // Events
    [q,cat,sort,per].forEach(el=>{
      el.addEventListener('change', ()=>{
        page = 1;
        history.replaceState({},'', makeURL({page:1}));
        render();
      });
      if(el===q){ el.addEventListener('input', ()=>{ page=1; history.replaceState({},'', makeURL({page:1})); render(); }); }
    });

    render();
  })();
  </script>
</body>
</html>
