<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ForgeFinds — Cool Tech & Deals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/forgefinds-favicon.png" />
  <style>
    :root{--bg:#0f1115;--card:#12151d;--line:#202635;--text:#e6edf6;--muted:#a7b0bf;--accent:#f97316;--good:#9ef199;--goodbg:#1e2a1e;--couponbg:#19233a;--couponfg:#9dc4ff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    header{padding:18px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #202635;background:#0f1115}
    a.logo{display:flex;align-items:center;gap:10px;color:inherit;text-decoration:none}
    header img{width:28px;height:28px}
    header nav a{color:#e6edf6;text-decoration:none}
    main{padding:20px}
    h1{font-size:40px;margin:0 0 8px} p.lede{color:var(--muted);margin:0 0 18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .deal-card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .deal-card .imgwrap{display:block;background:#0b0d10}
    .deal-card img{width:100%;height:220px;object-fit:cover}
    .deal-card .content{padding:12px 14px}
    .deal-card .title{font-size:1.05rem;line-height:1.25;margin:0 0 6px}
    .deal-card .desc{color:var(--muted);font-size:.9rem;margin:0 0 10px}
    .deal-card .meta{display:flex;align-items:center;gap:8px;margin:0 0 10px;flex-wrap:wrap}
    .price{background:var(--goodbg);color:var(--good);padding:4px 8px;border-radius:8px;font-weight:600}
    .badge.coupon{background:var(--couponbg);color:var(--couponfg);padding:4px 8px;border-radius:8px;font-weight:600}
    .badge.off{background:#1b1530;color:#c9a7ff;padding:4px 8px;border-radius:8px;font-weight:700}
    .cta{display:inline-block;background:var(--accent);color:#0b0d10;font-weight:700;border-radius:10px;padding:10px 12px;text-align:center}
    .empty{color:var(--muted)}
    /* debug */
    #debug{position:fixed;inset:auto 12px 12px 12px;background:#1a1d24;border:1px solid #2a3140;border-radius:10px;color:#cde;max-height:40vh;overflow:auto;padding:10px;display:none;z-index:9999}
    #debug pre{white-space:pre-wrap;margin:0;font:12px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    #debug strong{color:#ffb} #debug.show{display:block}
  </style>
</head>
<body>
  <header>
    <a class="logo" href="/"><img src="/forgefinds-logo.png" alt="ForgeFinds"><strong>ForgeFinds</strong></a>
    <nav><a href="/browse.html">Browse all Deals</a></nav>
  </header>

  <main>
    <h1>Latest deals!</h1>
    <p class="lede">Fresh tech finds, updated as we post.</p>
    <section id="deals" class="grid"></section>
  </main>

  <div id="debug"><strong>Diagnostics</strong><pre id="dbg"></pre></div>

  <script>
  (async function(){
    const dbg = (m) => { const box = document.getElementById('debug'); const pre = document.getElementById('dbg');
      pre.textContent += (typeof m==='string'? m : JSON.stringify(m,null,2)) + "\n"; box.classList.add('show'); };
    const q = new URL(location.href).searchParams;
    const includeScheduled = q.get('scheduled') === '1';

    function parseISO(s=""){ return new Date(s); }
    function now(){ return new Date(); }
    function money(s){ return s || ""; }
    function esc(s=""){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function renderList(list){
      const mount = document.querySelector("#deals");
      if (!mount) return;
      if (!list.length){ mount.innerHTML = `<p class="empty">No live deals yet. Check back soon.</p>`; return; }
      const html = list.map(d => {
        const priceText = d.display_price || d.price_info || "";
        const offBadge = (d.__pctOff != null) ? `<span class="badge off">${d.__pctOff}% off</span>` : "";
        const coupon = d.coupon ? `<span class="badge coupon">${esc(d.coupon)}</span>` : "";
        return `
          <article class="deal-card">
            <a class="imgwrap" href="${d.affiliate_url}" target="_blank" rel="nofollow noopener">
              <img loading="lazy" src="${d.image_url}" alt="${esc(d.title || "")}">
            </a>
            <div class="content">
              <h3 class="title">${esc(d.title || "")}</h3>
              <p class="desc">${esc(d.description || "")}</p>
              <div class="meta">
                <span class="price">${money(priceText)}</span>
                ${offBadge}
                ${coupon}
              </div>
              <a class="cta" href="${d.affiliate_url}" target="_blank" rel="nofollow noopener">Shop at ${esc(d.store || "Amazon")}</a>
            </div>
          </article>`;
      }).join("");
      mount.innerHTML = html;
    }

    function derive(d){
      // current price
      const dollarsOne = (str)=>{ if(!str) return null; const m=/\$([\d,]+(?:\.\d{1,2})?)/.exec(str); return m?parseFloat(m[1].replace(/,/g,"")):null; };
      const percentOne = (str)=>{ if(!str) return null; const m=/(\d{1,3})\s*%/.exec(str); return m?parseFloat(m[1]):null; };
      const moneyRx = /\$([\d,]+(?:\.\d{1,2})?)/g;
      const extractWas = (info="")=>{
        const m=/was[^$]*\$([\d,]+(?:\.\d{1,2})?)/i.exec(info);
        if(m) return parseFloat(m[1].replace(/,/g,""));
        const monies=[...info.matchAll(moneyRx)].map(m=>parseFloat(m[1].replace(/,/g,"")));
        if(monies.length>=2){ const a=monies[0], b=monies[monies.length-1]; if(b>a) return b; }
        return null;
      };

      let price = dollarsOne(d.display_price) ?? dollarsOne(d.price_info);
      const couponText = (d.coupon||"").toLowerCase();
      const dollarOff = dollarsOne(couponText);
      const pctOffCoupon = percentOne(couponText);
      if(price!=null){
        if(pctOffCoupon!=null) price = +(price*(1-pctOffCoupon/100)).toFixed(2);
        if(dollarOff!=null) price = Math.max(0, +(price - dollarOff).toFixed(2));
      }
      let pct = pctOffCoupon ?? percentOne(d.price_info||"");
      if(pct==null && price!=null){
        const was = extractWas(d.price_info||"");
        if(was && was>0 && price<=was) pct = Math.round(100*(1-price/was));
      }
      return { ...d, __price: price, __pctOff: pct };
    }

    try{
      dbg("Loading /data/deals.json …");
      const res = await fetch(`/data/deals.json?cb=${Date.now()}`);
      dbg(`HTTP ${res.status}`);
      if(!res.ok) throw new Error(`Failed to fetch deals.json (${res.status})`);
      const raw = await res.json();
      dbg({count: raw.length, first: raw[0]});

      const n = now();
      const list = raw
        .filter(d=>{
          const pub = parseISO(d.publish_at || d.created_at || "1970-01-01T00:00:00-04:00");
          const exp = parseISO(d.expires_at || "9999-12-31T23:59:59-04:00");
          return includeScheduled ? true : (pub <= n && exp > n);
        })
        .sort((a,b)=> parseISO(b.publish_at||b.created_at) - parseISO(a.publish_at||a.created_at))
        .map(derive);

      renderList(list);
      dbg(`Rendered ${list.length} visible deals`);
    }catch(err){
      dbg(String(err.stack||err));
    }
  })();
  </script>
</body>
</html>
