<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>ForgeFinds Active Screener</title>
    <style>
        /* Dark Mode Theme */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; display: none; background-color: #121212; color: #e0e0e0; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #333; }
        .header img { height: 50px; width: auto; }
        .header h1 { margin: 0; font-size: 1.8rem; color: #fff; }
        
        .controls { background: #1e1e1e; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;}
        .status-box { flex-grow: 1; }
        
        button { padding: 12px 24px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #444; cursor: not-allowed; opacity: 0.7; }

        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: #1e1e1e; box-shadow: 0 4px 15px rgba(0,0,0,0.3); border-radius: 12px; overflow: hidden; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #333; }
        th { background-color: #2c2c2c; color: #aaa; text-transform: uppercase; font-size: 0.8em; letter-spacing: 1px; }
        tr:hover { background-color: #2a2a2a; }
        
        td b a { color: #fff; text-decoration: none; font-size: 1.1em; }
        .green { color: #4cd964; font-weight: bold; }
        .news-button { display: inline-block; padding: 6px 12px; background-color: #333; color: #62b0ff; text-decoration: none; font-size: 0.85em; border-radius: 4px; transition: background 0.2s; }
        .news-button:hover { background-color: #444; color: #fff; }

        #status { font-weight: 500; font-size: 1.1em; margin-bottom: 5px; color: #fff; }
        .tally-container { font-size: 0.9em; color: #aaa; background: #252525; padding: 8px 12px; border-radius: 20px; display: inline-block; }
        #counterStr { color: #fff; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <img src="../../forgefinds-logo.png" alt="ForgeFinds Logo">
        <h1>Market Scanner</h1>
    </div>
    
    <div class="controls">
        <div class="status-box">
            <div id="status">Ready to scan.</div>
            <div class="tally-container">Calls remaining today: <span id="counterStr">--</span></div>
        </div>
        <button id="scanBtn" onclick="runScreener()">Scan Top Gainers</button>
    </div>

    <table id="resultsTable">
        <thead>
            <tr>
                <th>Ticker</th>
                <th>Price</th>
                <th>% Change</th>
                <th>Volume</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // --- CONFIGURATION ---
        const API_KEY = '1SB71KH1HDJVZ3WM'; 
        const SITE_PASSWORD = 'bang'; 
        // ---------------------

        // --- API COUNTER LOGIC ---
        const todayStr = new Date().toLocaleDateString();
        let callsLeft = 25;

        if (localStorage.getItem('lastRunDate') !== todayStr) {
            // New day, reset counter
            localStorage.setItem('lastRunDate', todayStr);
            localStorage.setItem('callsLeft', 25);
        } else {
            // Same day, load existing counter
            callsLeft = parseInt(localStorage.getItem('callsLeft')) || 0;
        }
        document.getElementById('counterStr').textContent = callsLeft;
        // -------------------------


        // Security Gate
        const userPass = prompt("Enter Access Code:");
        if (userPass === SITE_PASSWORD) {
            document.body.style.display = 'block';
        } else {
            document.body.innerHTML = '<h1 style="text-align:center; margin-top:50px; color: #d9534f;">Access Denied</h1>';
            document.body.style.display = 'block';
        }

        async function runScreener() {
            const status = document.getElementById('status');
            const tbody = document.querySelector('#resultsTable tbody');
            const btn = document.getElementById('scanBtn');
            const counterDisplay = document.getElementById('counterStr');
            
            if (callsLeft <= 0) {
                 status.innerHTML = "<span style='color:#d9534f'>Daily limit reached. Try again tomorrow.</span>";
                 btn.disabled = true;
                 return;
            }

            // Update UI status and disable button
            status.textContent = "Fetching Top Gainers...";
            btn.disabled = true;
            btn.textContent = "Scanning...";
            tbody.innerHTML = ''; 

            try {
                const url = `https://www.alphavantage.co/query?function=TOP_GAINERS_LOSERS&apikey=${API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();

                // Decrement counter on successful fetch attempt
                callsLeft--;
                localStorage.setItem('callsLeft', callsLeft);
                counterDisplay.textContent = callsLeft;

                if (data["Information"] && data["Information"].includes("rate limit")) {
                    status.innerHTML = "<span style='color:#d9534f'>API Limit Reached at source.</span>";
                    callsLeft = 0; // Force counter to 0 just in case
                    localStorage.setItem('callsLeft', 0);
                    counterDisplay.textContent = 0;
                    return;
                }
                 if (data["Error Message"]) {
                    status.textContent = "Error: System Error or Invalid Key.";
                    return;
                }

                const gainers = data.top_gainers || [];

                // Filter: Price $2 - $20
                let filtered = gainers.filter(stock => {
                    const price = parseFloat(stock.price);
                    return price >= 2 && price <= 20;
                });

                if (filtered.length === 0) {
                    status.textContent = "No gainers found between $2 - $20.";
                    return;
                }

                status.innerHTML = `Found <span class="green">${filtered.length}</span> movers ($2-$20).`;

                filtered.forEach(stock => {
                    // Format percentage to 2 decimal places
                    let cleanPercent = parseFloat(stock.change_percentage).toFixed(2);

                    const row = `<tr>
                        <td><b><a href="https://finance.yahoo.com/quote/${stock.ticker}" target="_blank">${stock.ticker}</a></b></td>
                        <td>$${stock.price}</td>
                        <td class="green">+${cleanPercent}%</td>
                        <td>${parseInt(stock.volume).toLocaleString()}</td>
                        <td><a href="https://finance.yahoo.com/quote/${stock.ticker}/news" target="_blank" class="news-button">News</a></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });

            } catch (error) {
                console.error(error);
                status.textContent = "Error connecting to API.";
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.textContent = "Scan Top Gainers";
            }
        }
    </script>
</body>
</html>
